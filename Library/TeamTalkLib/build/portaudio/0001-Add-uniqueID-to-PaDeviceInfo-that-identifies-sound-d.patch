From 47ce494f57d9e1cb1b7840278918cd080427a50a Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Bj=C3=B8rn=20Damstedt=20Rasmussen?= <contact@bearware.dk>
Date: Wed, 5 Nov 2025 20:29:14 +0100
Subject: [PATCH 1/2] Add 'uniqueID' to PaDeviceInfo that identifies sound
 device

---
 include/portaudio.h                |  1 +
 src/hostapi/dsound/pa_win_ds.c     |  9 +++++++++
 src/hostapi/wasapi/pa_win_wasapi.c |  6 ++++++
 src/hostapi/wmme/pa_win_wmme.c     | 12 ++++++++++--
 4 files changed, 26 insertions(+), 2 deletions(-)

diff --git a/include/portaudio.h b/include/portaudio.h
index b8878cc..2e93324 100644
--- a/include/portaudio.h
+++ b/include/portaudio.h
@@ -523,6 +523,7 @@ typedef struct PaDeviceInfo
     PaTime defaultHighOutputLatency;
 
     double defaultSampleRate;
+    const char* uniqueID;
 } PaDeviceInfo;
 
 
diff --git a/src/hostapi/dsound/pa_win_ds.c b/src/hostapi/dsound/pa_win_ds.c
index ae4f277..de17a3d 100644
--- a/src/hostapi/dsound/pa_win_ds.c
+++ b/src/hostapi/dsound/pa_win_ds.c
@@ -985,6 +985,15 @@ static PaError AddOutputDeviceInfoFromDirectSound(
 
         if( lpGUID == NULL )
             hostApi->info.defaultOutputDevice = hostApi->info.deviceCount;
+        else
+        {
+            WCHAR GUIDstr[100] = { 0 };
+            deviceInfo->uniqueID = (char*)PaUtil_GroupAllocateZeroInitializedMemory(winDsHostApi->allocations, 100);
+            StringFromGUID2(lpGUID, GUIDstr, 100);
+            if (deviceInfo->uniqueID)
+                WideCharToMultiByte(CP_UTF8, 0, GUIDstr, (INT32)wcslen(GUIDstr), deviceInfo->uniqueID, 100 - 1, 0, 0);
+        }
+
 
         hostApi->info.deviceCount++;
     }
diff --git a/src/hostapi/wasapi/pa_win_wasapi.c b/src/hostapi/wasapi/pa_win_wasapi.c
index b4e3273..8b9081c 100644
--- a/src/hostapi/wasapi/pa_win_wasapi.c
+++ b/src/hostapi/wasapi/pa_win_wasapi.c
@@ -1749,6 +1749,12 @@ static PaError FillDeviceInfo(PaWasapiHostApiRepresentation *paWasapi, void *pEn
         IF_FAILED_INTERNAL_ERROR_JUMP(hr, result, error);
 
         wcsncpy(wasapiDeviceInfo->deviceId, deviceId, PA_WASAPI_DEVICE_ID_LEN - 1);
+
+        {
+            deviceInfo->uniqueID = (char*)PaUtil_GroupAllocateZeroInitializedMemory(paWasapi->allocations, (long)PA_WASAPI_DEVICE_ID_LEN * sizeof(char));
+            WideCharToMultiByte(CP_UTF8, 0, wasapiDeviceInfo->deviceId, (INT32)wcslen(wasapiDeviceInfo->deviceId), deviceInfo->uniqueID, PA_WASAPI_DEVICE_ID_LEN - 1, 0, 0);
+        }
+
         CoTaskMemFree(deviceId);
     }
 
diff --git a/src/hostapi/wmme/pa_win_wmme.c b/src/hostapi/wmme/pa_win_wmme.c
index 3639d6d..b46ea1f 100644
--- a/src/hostapi/wmme/pa_win_wmme.c
+++ b/src/hostapi/wmme/pa_win_wmme.c
@@ -677,13 +677,13 @@ static PaError InitializeInputDeviceInfo( PaWinMmeHostApiRepresentation *winMmeH
     PaError result = paNoError;
     char *deviceName; /* non-const ptr */
     MMRESULT mmresult;
-    WAVEINCAPSW wic;
+    WAVEINCAPS2W wic;
     PaDeviceInfo *deviceInfo = &winMmeDeviceInfo->inheritedDeviceInfo;
     size_t len;
 
     *success = 0;
 
-    mmresult = waveInGetDevCapsW( winMmeInputDeviceId, &wic, sizeof( WAVEINCAPSW ) );
+    mmresult = waveInGetDevCapsW( winMmeInputDeviceId, &wic, sizeof(wic) );
     if( mmresult == MMSYSERR_NOMEM )
     {
         result = paInsufficientMemory;
@@ -760,6 +760,14 @@ static PaError InitializeInputDeviceInfo( PaWinMmeHostApiRepresentation *winMmeH
     DetectDefaultSampleRate( winMmeDeviceInfo, winMmeInputDeviceId,
             QueryInputWaveFormatEx, deviceInfo->maxInputChannels );
 
+    if (memcmp(&wic.NameGuid, &GUID_NULL, sizeof(wic.NameGuid)) != 0)
+    {
+        WCHAR GUIDstr[100] = { 0 };
+        deviceInfo->uniqueID = (char*)PaUtil_GroupAllocateZeroInitializedMemory(winMmeHostApi->allocations, (long)100 * sizeof(char));
+        StringFromGUID2(&wic.NameGuid, GUIDstr, 100);
+        if (deviceInfo->uniqueID)
+            CopyWCharStringToUtf8CString(deviceInfo->uniqueID, 100, GUIDstr);
+    }
     *success = 1;
 
 error:
-- 
2.45.1

